module backend.proxy;

extern(C) void assert(int);
extern(C) void _branchRecord_resolve(void*, int);

class BranchRecord {
    void* ptr;
    this(void* ptr) { this.ptr = ptr; }
    void resolve(int target) {
        _branchRecord_resolve(this.ptr, target);
    }
}

extern(C) void _testBranchRecord_resolveThen(void*, int);
extern(C) void _testBranchRecord_resolveElse(void*, int);

class TestBranchRecord {
    void* ptr;
    this(void* ptr) { this.ptr = ptr; }
    void resolveThen(int target) {
        _testBranchRecord_resolveThen(this.ptr, target);
    }
    void resolveElse(int target) {
        _testBranchRecord_resolveElse(this.ptr, target);
    }
}

extern(C) int _backendFunction_arg(void*, int);
extern(C) int _backendFunction_intLiteral(void*, int);
extern(C) int _backendFunction_longLiteral(void*, long);
extern(C) int _backendFunction_stringLiteral(void*, string);
extern(C) int _backendFunction_wordLiteral(void*, void*, size_t);
extern(C) int _backendFunction_voidLiteral(void*);
extern(C) int _backendFunction_binop(void*, string, int, int, int);
extern(C) int _backendFunction_zeroExtend(void*, int, int, int);
extern(C) int _backendFunction_call(void*, void*, string, int[]);
extern(C) int _backendFunction_callFuncPtr(void*, void*, int, int[]);
extern(C) int _backendFunction_getFuncPtr(void*, string);
extern(C) int _backendFunction_load(void*, void*, int);
extern(C) int _backendFunction_alloca(void*, void*);
extern(C) int _backendFunction_field(void*, void*, int, int);
extern(C) int _backendFunction_fieldOffset(void*, void*, int, int);
extern(C) void _backendFunction_store(void*, void*, int, int);
extern(C) int _backendFunction_ret(void*, int);
extern(C) void* _backendFunction_branch(void*);
extern(C) void* _backendFunction_testBranch(void*, int);
extern(C) int _backendFunction_blockIndex(void*);

class BackendFunction {
    void* ptr;
    this(void* ptr) { this.ptr = ptr; }
    int arg(int index) {
        return _backendFunction_arg(this.ptr, index);
    }
    int intLiteral(int value) {
        return _backendFunction_intLiteral(this.ptr, value);
    }
    int longLiteral(long value) {
        return _backendFunction_longLiteral(this.ptr, value);
    }
    int wordLiteral(Platform platform, size_t value) {
        return _backendFunction_wordLiteral(this.ptr, platform.platform, value);
    }
    int stringLiteral(string text) {
        return _backendFunction_stringLiteral(this.ptr, text);
    }
    int voidLiteral() {
        return _backendFunction_voidLiteral(this.ptr);
    }
    int binop(string op, int size, int left, int right) {
        return _backendFunction_binop(this.ptr, op, size, left, right);
    }
    int zeroExtend(int value, int from, int to) {
        return _backendFunction_zeroExtend(this.ptr, value, from, to);
    }
    int call(void* ret, char[] name, int[] args) {
        return _backendFunction_call(this.ptr, ret, name, args);
    }
    int getFuncPtr(string name) {
        return _backendFunction_getFuncPtr(this.ptr, name);
    }
    int callFuncPtr(void* type, int reg, int[] args) {
        return _backendFunction_callFuncPtr(this.ptr, type, reg, args);
    }
    int load(void* backendType, int reg) {
        return _backendFunction_load(this.ptr, backendType, reg);
    }
    int alloca(void* backendType) {
        return _backendFunction_alloca(this.ptr, backendType);
    }
    int field(void* backendType, int reg, int index) {
        return _backendFunction_field(this.ptr, backendType, reg, index);
    }
    int fieldOffset(void* backendType, int reg, int index) {
        return _backendFunction_fieldOffset(this.ptr, backendType, reg, index);
    }
    void store(void* backendType, int target_reg, int value_reg) {
        return _backendFunction_store(this.ptr, backendType, target_reg, value_reg);
    }
    void ret(int reg) {
        _backendFunction_ret(this.ptr, reg);
    }
    BranchRecord branch() {
        return new BranchRecord(_backendFunction_branch(this.ptr));
    }
    TestBranchRecord testBranch(int reg) {
        return new TestBranchRecord(_backendFunction_testBranch(this.ptr, reg));
    }
    int blockIndex()
    {
        return _backendFunction_blockIndex(this.ptr);
    }
}

extern(C) void* _backendModule(); // current module
extern(C) void* _backendModule_define(void*, char[], void*, void*[]);
extern(C) void* _backendModule_backend(void*);
extern(C) void* _backendModule_platform(void*);
// extern(C) void _backendModule_call(void*, void*, char[], void*[]);
extern(C) void _backendModule_callMain(void*, char[][]);
extern(C) void _backendModule_dump(void*);

class BackendModule {
    void* ptr;
    this(void* ptr) { this.ptr = ptr; }
    BackendFunction define(char[] name, void* ret, void*[] args)
    {
        return new BackendFunction(_backendModule_define(this.ptr, name, ret, args));
    }
    /*void call(void* ret_ptr, char[] name, void*[] args)
    {
        _backendModule_call(this.ptr, ret_ptr, name, args);
    }*/
    void callMain(string[] args)
    {
        _backendModule_callMain(this.ptr, args);
    }
    void dump()
    {
        _backendModule_dump(this.ptr);
    }
}

extern(C) void* _backend_createModule(void*, void*);
extern(C) void* _backend_charType();
extern(C) void* _backend_intType();
extern(C) void* _backend_longType();
extern(C) void* _backend_voidType();
extern(C) void* _backend_pointerType(void*);
extern(C) void* _backend_functionPointerType(void*, void*[]);
extern(C) void* _backend_structType(void*[]);

class Backend {
    void* ptr;
    this() { this.ptr = _backendModule_backend(_backendModule()); }
    BackendModule createModule() {
        return new BackendModule(
            _backend_createModule(this.ptr, _backendModule_platform(_backendModule())));
    }
}

extern(C) int _platform_size(void*, void*);
extern(C) int _platform_nativeWordSize(void*);

class Platform {
    void* backend;
    void* platform;
    this() {
        this.backend = _backendModule_backend(_backendModule());
        this.platform = _backendModule_platform(_backendModule());
    }
    void* longType() {
        return _backend_longType();
    }
    void* intType() {
        return _backend_intType();
    }
    void* charType() {
        return _backend_charType();
    }
    void* voidType() {
        return _backend_voidType();
    }
    void* structType(void*[] members) {
        return _backend_structType(members);
    }
    void* pointerType(void* target) {
        return _backend_pointerType(target);
    }
    void* functionPointerType(void* ret, void*[] args) {
        return _backend_functionPointerType(ret, args);
    }
    int nativeWordSize() {
        return _platform_nativeWordSize(this.platform);
    }
    int size(void* target) {
        return _platform_size(this.platform, target);
    }
}
